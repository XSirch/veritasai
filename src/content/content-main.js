/**
 * VeritasAI - Content Script Principal
 * Arquivo principal que coordena todos os m√≥dulos do content script
 */

console.log('üîÑ Iniciando content-main.js');

// Importar m√≥dulos (ser√° bundled pelo webpack)
import { TextDetector } from './modules/text-detector.js';
import { UIManager } from './modules/ui-manager.js';
import { CommunicationManager } from './modules/communication-manager.js';
import { EventManager } from './modules/event-manager.js';
import { StyleManager } from './modules/style-manager.js';
import { getIntegrationService } from '../services/integration-service.js';
import { notify, getNotificationSystem } from '../utils/user-notifications.js';
import { ResultTooltip } from './ui-components.js';

console.log('‚úÖ Todas as importa√ß√µes conclu√≠das');

// Configura√ß√£o global
const VERITAS_CONFIG = {
  MIN_TEXT_LENGTH: 10,
  MAX_TEXT_LENGTH: 5000,
  TOOLTIP_DELAY: 100,
  AUTO_HIDE_DELAY: 5000,
  DEBOUNCE_DELAY: 300,
  Z_INDEX_BASE: 10000,
  AUTO_VERIFY: false // Configura√ß√£o de verifica√ß√£o autom√°tica
};

// Estado global da extens√£o
let extensionState = {
  enabled: true,
  currentTooltip: null,
  currentButton: null,
  lastSelection: null,
  settings: {},
  isProcessing: false
};

// Expor classes globalmente para testes E2E
console.log('üîß Definindo window.VeritasAI...');
if (typeof window !== 'undefined') {
  window.ResultTooltip = ResultTooltip;
  window.VeritasAI = {
    ResultTooltip,
    extensionState,
    VERITAS_CONFIG
  };
  console.log('‚úÖ window.VeritasAI definido:', window.VeritasAI);
} else {
  console.log('‚ùå window n√£o est√° dispon√≠vel');
}

/**
 * Classe principal do Content Script
 */
class VeritasContentScript {
  constructor() {
    this.textDetector = null;
    this.uiManager = null;
    this.communicationManager = null;
    this.eventManager = null;
    this.styleManager = null;
    this.integrationService = null;
    this.notificationSystem = null;

    this.init();
  }
  
  /**
   * Inicializa√ß√£o do content script
   */
  async init() {
    console.log('üöÄ Inicializando VeritasAI Content Script v2.0');

    try {
      // Carregar configura√ß√µes
      await this.loadSettings();

      if (!extensionState.enabled) {
        console.log('‚ÑπÔ∏è VeritasAI est√° desabilitado');
        return;
      }

      // Inicializar servi√ßos de integra√ß√£o
      this.integrationService = getIntegrationService();
      this.notificationSystem = getNotificationSystem();

      // Inicializar m√≥dulos
      this.initializeModules();

      // Configurar comunica√ß√£o
      this.setupCommunication();

      // Configurar eventos
      this.setupEvents();

      // Configurar integra√ß√£o end-to-end
      this.setupEndToEndIntegration();

      // Injetar estilos
      this.styleManager.injectStyles();

      console.log('‚úÖ VeritasAI Content Script inicializado com sucesso');

      // Notificar inicializa√ß√£o
      notify.info(
        'VeritasAI ativo',
        'Selecione texto para verificar informa√ß√µes',
        { duration: 3000 }
      );

    } catch (error) {
      console.error('‚ùå Erro na inicializa√ß√£o do VeritasAI:', error);

      // Notificar erro de inicializa√ß√£o
      notify.error(
        'Erro de inicializa√ß√£o',
        'VeritasAI n√£o p√¥de ser carregado',
        { duration: 5000 }
      );
    }
  }
  
  /**
   * Inicializa todos os m√≥dulos
   */
  initializeModules() {
    // Gerenciador de comunica√ß√£o
    this.communicationManager = new CommunicationManager();
    
    // Detector de texto
    this.textDetector = new TextDetector(VERITAS_CONFIG);
    
    // Gerenciador de UI
    this.uiManager = new UIManager(VERITAS_CONFIG, extensionState);
    
    // Gerenciador de eventos
    this.eventManager = new EventManager(
      this.textDetector,
      this.uiManager,
      this.communicationManager,
      extensionState
    );
    
    // Gerenciador de estilos
    this.styleManager = new StyleManager();
  }
  
  /**
   * Configura comunica√ß√£o com background
   */
  setupCommunication() {
    this.communicationManager.onMessage('verifySelectedText', () => {
      if (extensionState.lastSelection) {
        this.verifyText(extensionState.lastSelection);
      }
    });
    
    this.communicationManager.onMessage('verifySelection', () => {
      this.eventManager.handleTextSelection();
    });
    
    this.communicationManager.onMessage('extensionToggled', (data) => {
      extensionState.enabled = data.enabled;
      if (!extensionState.enabled) {
        this.uiManager.hideAllElements();
      }
    });
    
    this.communicationManager.onMessage('settingsUpdated', () => {
      this.loadSettings();
    });
  }
  
  /**
   * Configura eventos principais
   */
  setupEvents() {
    this.eventManager.setupAllListeners();
  }

  /**
   * Configura integra√ß√£o end-to-end entre todos os componentes
   */
  setupEndToEndIntegration() {
    console.log('üîó Configurando integra√ß√£o end-to-end...');

    // Configurar listeners para eventos de verifica√ß√£o
    document.addEventListener('veritas:text-selected', (event) => {
      this.handleTextSelectionEvent(event.detail);
    });

    document.addEventListener('veritas:verify-request', (event) => {
      this.handleVerifyRequestEvent(event.detail);
    });

    document.addEventListener('veritas:display-tooltip', (event) => {
      this.handleDisplayTooltipEvent(event.detail);
    });

    // Configurar listeners para notifica√ß√µes
    document.addEventListener('veritas:notification-action', (event) => {
      this.handleNotificationActionEvent(event.detail);
    });

    // Configurar listeners para mudan√ßas de estado
    document.addEventListener('veritas:state-change', (event) => {
      this.handleStateChangeEvent(event.detail);
    });

    console.log('‚úÖ Integra√ß√£o end-to-end configurada');
  }
  
  /**
   * Carrega configura√ß√µes da extens√£o
   */
  async loadSettings() {
    try {
      const response = await this.communicationManager.sendMessage('getSettings');
      
      if (response && response.success) {
        extensionState.enabled = response.data?.enabled ?? true;
        extensionState.settings = response.data || {};
        
        // Aplicar configura√ß√µes espec√≠ficas
        this.applySettings(extensionState.settings);
      }
    } catch (error) {
      console.warn('Erro ao carregar configura√ß√µes:', error);
    }
  }
  
  /**
   * Aplica configura√ß√µes carregadas
   */
  applySettings(settings) {
    if (settings.minTextLength) {
      VERITAS_CONFIG.MIN_TEXT_LENGTH = settings.minTextLength;
    }
    if (settings.maxTextLength) {
      VERITAS_CONFIG.MAX_TEXT_LENGTH = settings.maxTextLength;
    }
    if (settings.autoHideDelay) {
      VERITAS_CONFIG.AUTO_HIDE_DELAY = settings.autoHideDelay;
    }

    // Aplicar configura√ß√£o de verifica√ß√£o autom√°tica
    if (typeof settings.autoVerify !== 'undefined') {
      VERITAS_CONFIG.AUTO_VERIFY = settings.autoVerify;
    }

    console.log('‚öôÔ∏è Configura√ß√µes aplicadas:', {
      autoVerify: VERITAS_CONFIG.AUTO_VERIFY,
      minTextLength: VERITAS_CONFIG.MIN_TEXT_LENGTH,
      maxTextLength: VERITAS_CONFIG.MAX_TEXT_LENGTH
    });
  }
  
  /**
   * Verifica texto selecionado (m√©todo integrado end-to-end)
   */
  async verifyText(selectionData, options = {}) {
    if (extensionState.isProcessing) {
      console.log('‚è∏Ô∏è Verifica√ß√£o j√° em andamento');
      notify.warning(
        'Verifica√ß√£o em andamento',
        'Aguarde a conclus√£o da an√°lise atual',
        { duration: 3000 }
      );
      return;
    }

    extensionState.isProcessing = true;

    try {
      // Esconder elementos anteriores
      this.uiManager.hideAllElements();

      // Preparar dados para envio
      const requestData = {
        text: selectionData.text,
        context: selectionData.context,
        contentType: selectionData.contentType,
        url: selectionData.url,
        domain: selectionData.domain,
        timestamp: selectionData.timestamp,
        strategy: options.strategy || 'comprehensive'
      };

      // Usar o servi√ßo de integra√ß√£o para coordenar o fluxo
      const result = await this.integrationService.executeVerificationFlow(
        requestData,
        { tab: { id: 'content-script' } }
      );

      // Esconder loading (ser√° gerenciado pelo integration service)
      this.uiManager.hideAllElements();
      extensionState.isProcessing = false;

      if (result.success) {
        // Mostrar resultado via tooltip avan√ßado
        this.uiManager.showResultTooltip(result.data, selectionData);

        // Disparar evento de sucesso
        document.dispatchEvent(new CustomEvent('veritas:verification-success', {
          detail: { result: result.data, selectionData, verificationId: result.verificationId }
        }));
      } else {
        // Mostrar erro via tooltip
        this.uiManager.showErrorTooltip(result.error || 'Erro na verifica√ß√£o', selectionData);

        // Disparar evento de erro
        document.dispatchEvent(new CustomEvent('veritas:verification-error', {
          detail: { error: result.error, selectionData, verificationId: result.verificationId }
        }));
      }

    } catch (error) {
      console.error('Erro na verifica√ß√£o:', error);
      this.uiManager.hideAllElements();
      extensionState.isProcessing = false;
      this.uiManager.showErrorTooltip('Erro de comunica√ß√£o', selectionData);

      // Disparar evento de erro
      document.dispatchEvent(new CustomEvent('veritas:verification-error', {
        detail: { error: error.message, selectionData }
      }));
    }
  }
  
  /**
   * Obt√©m inst√¢ncia do detector de texto
   */
  getTextDetector() {
    return this.textDetector;
  }
  
  /**
   * Obt√©m inst√¢ncia do gerenciador de UI
   */
  getUIManager() {
    return this.uiManager;
  }
  
  /**
   * Obt√©m inst√¢ncia do gerenciador de comunica√ß√£o
   */
  getCommunicationManager() {
    return this.communicationManager;
  }

  /**
   * Manipula evento de sele√ß√£o de texto
   */
  handleTextSelectionEvent(detail) {
    console.log('üìù Texto selecionado:', detail);

    // Atualizar estado
    extensionState.lastSelection = detail;

    // Mostrar bot√£o de verifica√ß√£o
    this.uiManager.showVerifyButton(detail);

    // Notificar sele√ß√£o
    notify.info(
      'Texto selecionado',
      `${detail.text.length} caracteres prontos para verifica√ß√£o`,
      { duration: 2000 }
    );
  }

  /**
   * Manipula evento de solicita√ß√£o de verifica√ß√£o
   */
  async handleVerifyRequestEvent(detail) {
    console.log('üîç Solicita√ß√£o de verifica√ß√£o:', detail);

    // Executar verifica√ß√£o
    await this.verifyText(detail.selectionData);
  }

  /**
   * Manipula evento de exibi√ß√£o de tooltip
   */
  handleDisplayTooltipEvent(detail) {
    console.log('üí¨ Exibindo tooltip:', detail);

    // Usar UIManager para mostrar tooltip
    this.uiManager.showResultTooltip(detail.result, detail.selectionData);
  }

  /**
   * Manipula evento de a√ß√£o de notifica√ß√£o
   */
  handleNotificationActionEvent(detail) {
    console.log('üîî A√ß√£o de notifica√ß√£o:', detail);

    const { action, data } = detail;

    switch (action) {
      case 'retry-verification':
        if (data.selectionData) {
          this.verifyText(data.selectionData);
        }
        break;

      case 'show-details':
        if (data.result) {
          this.uiManager.showResultTooltip(data.result, data.selectionData);
        }
        break;

      case 'cancel-verification':
        if (data.verificationId) {
          this.integrationService.cancelVerification(data.verificationId);
        }
        break;
    }
  }

  /**
   * Manipula evento de mudan√ßa de estado
   */
  handleStateChangeEvent(detail) {
    console.log('‚ö° Mudan√ßa de estado:', detail);

    const { type, data } = detail;

    switch (type) {
      case 'extension-toggled':
        extensionState.enabled = data.enabled;
        if (!data.enabled) {
          this.uiManager.hideAllElements();
          notify.info('VeritasAI desativado', 'Extens√£o pausada', { duration: 2000 });
        } else {
          notify.info('VeritasAI ativado', 'Extens√£o reativada', { duration: 2000 });
        }
        break;

      case 'settings-updated':
        this.loadSettings();
        notify.info('Configura√ß√µes atualizadas', 'Prefer√™ncias aplicadas', { duration: 2000 });
        break;

      case 'api-status-changed':
        if (data.status === 'connected') {
          notify.success('APIs conectadas', 'Servi√ßos funcionando', { duration: 3000 });
        } else if (data.status === 'error') {
          notify.error('Erro nas APIs', 'Verifique suas configura√ß√µes', { duration: 5000 });
        }
        break;
    }
  }

  /**
   * Cleanup ao destruir
   */
  destroy() {
    console.log('Destruindo VeritasAI Content Script...');

    // Limpar estado
    extensionState.currentTooltip = null;
    extensionState.currentButton = null;
    extensionState.lastSelection = null;
    extensionState.isProcessing = false;

    // Destruir servi√ßos de integra√ß√£o
    if (this.integrationService) {
      this.integrationService.destroy();
    }

    // Destruir m√≥dulos
    if (this.eventManager) {
      this.eventManager.cleanup();
    }

    if (this.uiManager) {
      this.uiManager.cleanup();
    }

    if (this.communicationManager) {
      this.communicationManager.cleanup();
    }

    if (this.styleManager) {
      this.styleManager.cleanup();
    }

    console.log('VeritasAI Content Script destru√≠do');
  }
}

// Inst√¢ncia global
let veritasContentScript = null;

/**
 * Inicializa√ß√£o quando DOM estiver pronto
 */
function initializeWhenReady() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      veritasContentScript = new VeritasContentScript();
    });
  } else {
    veritasContentScript = new VeritasContentScript();
  }
}

// Cleanup quando p√°gina for descarregada
window.addEventListener('beforeunload', () => {
  if (veritasContentScript) {
    veritasContentScript.destroy();
  }
});

// Inicializar
initializeWhenReady();

// Exportar para uso global se necess√°rio
window.VeritasContentScript = veritasContentScript;

console.log('üì¶ VeritasAI Content Script v2.0 carregado');
